"use strict";var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var fetchRestaurantsData=null,DBHelper=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"getDbUrl",value:function(){return"https://mnaz-restaurant-reviews-api.herokuapp.com/"+(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"")}},{key:"fetchRestaurants",value:function(){return fetchRestaurantsData||fetch(e.getDbUrl("restaurants")).then(function(e){return e.json()}).then(function(e){return fetchRestaurantsData=Promise.resolve(e),e}).catch(function(e){console.log(e)})}},{key:"fetchRestaurantById",value:function(t){return e.fetchRestaurants().then(function(e){return e.find(function(e){return e.id==t})})}},{key:"fetchRestaurantByCuisine",value:function(t){return e.fetchRestaurants().then(function(e){return e.filter(function(e){return e.cuisine_type==t})})}},{key:"fetchRestaurantByNeighborhood",value:function(t){return e.fetchRestaurants().then(function(e){return e.filter(function(e){return e.neighborhood==t})})}},{key:"fetchRestaurantByCuisineAndNeighborhood",value:function(t,n){return e.fetchRestaurants().then(function(e){var a=e;return"all"!=t&&(a=a.filter(function(e){return e.cuisine_type==t})),"all"!=n&&(a=a.filter(function(e){return e.neighborhood==n})),a})}},{key:"fetchNeighborhoods",value:function(){return e.fetchRestaurants().then(function(e){var t=e.map(function(t,n){return e[n].neighborhood});return t.filter(function(e,n){return t.indexOf(e)==n})})}},{key:"fetchCuisines",value:function(){return e.fetchRestaurants().then(function(e){var t=e.map(function(t,n){return e[n].cuisine_type});return t.filter(function(e,n){return t.indexOf(e)==n})})}},{key:"urlForRestaurant",value:function(e){return"./restaurant.html?id="+e.id}},{key:"imageUrlForRestaurant",value:function(e){return"/img/"+e.photograph}},{key:"srcsetImageUrlForRestaurant",value:function(e){return e.srcset_restaurant}},{key:"srcsetImageUrlForIndex",value:function(e){return e.srcset_index}},{key:"mapMarkerForRestaurant",value:function(t,n){var a=new L.marker([t.latlng.lat,t.latlng.lng],{title:t.name,alt:"Localisation of "+t.name+" restaurant",url:e.urlForRestaurant(t)});return a.addTo(newMap),a}},{key:"fetchReviewsByRestaurantId",value:function(t){return fetch(e.getDbUrl("reviews/?restaurant_id="+t)).then(function(e){return e.json()}).then(function(e){return e.filter(function(e){return e.restaurant_id==t})}).catch(function(e){console.log(e)})}},{key:"updateLocalRestaurantData",value:function(e,t){return fetchRestaurantsData.then(function(n){return n.map(function(n){return n.id===e?Object.assign(n,t):n})}).then(function(e){fetchRestaurantsData=Promise.resolve(e)})}},{key:"toggleFavoriteRestaurant",value:function(t,n){return e.updateLocalRestaurantData(t,{is_favorite:n}),fetch(e.getDbUrl("restaurants/"+t+"/"),{method:"PUT",body:JSON.stringify({is_favorite:n}),headers:{"Content-Type":"application/json"}}).then(function(e){if(302===e.status)throw"fallback";if(200===e.status||304===e.status)return e.json()}).catch(function(e){return console.log("Request failed",e),Promise.reject(e)})}}]),e}(),favoriteOnClick=function(){var e=this;this.disabled=!0;var t=parseInt(this.id.replace("fav-","")),n=!!this.classList.contains("favorite-icon--on"),a=this.classList.contains("favorite-icon--on")?"on":"off";this.classList.remove("favorite-icon--"+a),this.classList.add("favorite-icon--"+(!0==!n?"on":"off")),DBHelper.toggleFavoriteRestaurant(t,!n).then(function(t){e.classList.remove("favorite-icon--"+a),e.classList.add("favorite-icon--"+("true"===t.is_favorite.toString()?"on":"off")),e.disabled=!1}).catch(function(t){console.log(t),"fallback"===t&&(e.disabled=!1)})},favoriteClickListener=function(){var e=document.getElementsByClassName("favorite-icon");Array.from(e).forEach(function(e){e.addEventListener("click",favoriteOnClick)})},checkedRatingListener=function(){var e=document.querySelectorAll('#frating input[name="rating"]');0!==e.length&&Array.from(e).forEach(function(e){e.addEventListener("click",function(){this.checked=!0})})};function showMainContent(){document.getElementById("maincontent").classList.remove("visibility-hidden"),document.getElementById("maincontent").classList.add("fadein"),document.getElementById("footer").classList.remove("fixed-bottom"),document.querySelector(".loader").setAttribute("hidden",!0)}var restaurant=void 0,newMap=void 0;document.addEventListener("DOMContentLoaded",function(e){initMap(),checkedRatingListener()});var initMap=function(){return fetchRestaurantFromURL().then(function(e){e&&0!==e.length?(self.newMap=L.map("map",{center:[e.latlng.lat,e.latlng.lng],zoom:16,scrollWheelZoom:!1}),L.tileLayer("https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.jpg70?access_token={mapboxToken}",{mapboxToken:"pk.eyJ1IjoibW9oY2luZTkyIiwiYSI6ImNqa21lY3JoZjF1cGozcXBrOGI5cnRlNGkifQ.VcGgA3YMmeEWpARnDTyxDQ",maxZoom:18,attribution:'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',id:"mapbox.streets"}).addTo(newMap),fillBreadcrumb(),DBHelper.mapMarkerForRestaurant(self.restaurant,self.newMap)):console.log("No restaurant found")}).catch(function(e){console.log(e)})},fetchRestaurantFromURL=function(){if(self.restaurant)return self.restaurant;var e=getParameterByName("id");return e?DBHelper.fetchRestaurantById(e).then(function(e){return self.restaurant=e,e&&fillRestaurantHTML(),e}):Promise.reject("No restaurant id in URL")},fillRestaurantHTML=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:self.restaurant;document.getElementById("restaurant-name").innerHTML=e.name,document.getElementById("restaurant-address").innerHTML=e.address;var t=document.getElementById("restaurant-img");t.setAttribute("alt",e.name),t.className="restaurant-img",t.srcset=DBHelper.srcsetImageUrlForRestaurant(e),t.src=DBHelper.imageUrlForRestaurant(e),t.sizes="(max-width: 380px) 300px, (max-width: 480px) 400px, (max-width: 680px) 600px, (max-width: 768px) 800px, (max-width: 960px) 400px, (max-width: 1360px) 600px";var n=document.getElementById("restaurant-img-container"),a=document.createElement("button");a.title="Favorite",a.setAttribute("id","fav-"+e.id),a.classList.add("favorite-icon"),a.classList.add("favorite-icon--"+("true"===e.is_favorite.toString()?"on":"off")),n.append(a),favoriteClickListener(),document.getElementById("restaurant-cuisine").innerHTML=e.cuisine_type,e.operating_hours&&fillRestaurantHoursHTML(),fetchReviewsFromURL()},fillRestaurantHoursHTML=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:self.restaurant.operating_hours,t=document.getElementById("restaurant-hours");for(var n in e){var a=document.createElement("tr"),r=document.createElement("td");r.innerHTML=n,a.appendChild(r);var i=document.createElement("td");i.innerHTML=e[n],a.appendChild(i),t.appendChild(a)}},fetchReviewsFromURL=function(){if(self.reviews)return self.reviews;var e=getParameterByName("id");return e?DBHelper.fetchReviewsByRestaurantId(e).then(function(e){return e&&fillReviewsHTML(e),e}):Promise.reject("No restaurant id in URL")},fillReviewsHTML=function(e){var t=document.getElementById("reviews-container"),n=document.createElement("h2");n.innerHTML="Reviews",t.appendChild(n);var a=document.getElementById("reviews-list");if(0===e.length||!e){var r=document.createElement("p"),i=!1===navigator.onLine?"No reviews available offline. You can post offline ,your reviews will saved offline & auto-submit when you're online":"No reviews yet. Be the first one to write a review.";return r.innerHTML=i,r.id="reviewsMsgContainer",t.appendChild(r),void t.appendChild(a)}e.length>1?e.forEach(function(e){a.appendChild(createReviewHTML(e))}):a.appendChild(createReviewHTML(e)),t.appendChild(a),showMainContent()},createReviewHTML=function(e){var t=document.getElementById("reviewsMsgContainer");if(!1===navigator.onLine&&null!==t){t.innerHTML="You can post offline ,your reviews will saved offline & auto-submit when you're online"}var n=document.createElement("li");n.classList.add("fadein");var a=document.createElement("div");a.className="review-header";var r=document.createElement("p");r.innerHTML=e.name,r.className="name",a.appendChild(r);var i=document.createElement("p");if(e.storageLocal)i.innerHTML="Stored locally",i.className="date";else{i.innerHTML=e.updatedAt?new Date(e.updatedAt).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}):"Stored locally",i.className="date"}a.appendChild(i),n.appendChild(a);var o=document.createElement("div");o.className="rating";for(var s=1;s<=5;s++){var c=document.createElement("span");c.innerHTML="★",c.className=e.rating>=s?"icon--active":"icon",o.appendChild(c)}n.appendChild(o);var l=document.createElement("p");return l.innerHTML=e.comments,l.className="comment",n.appendChild(l),n},postReview=function(){var e=void 0;document.querySelectorAll('#frating input[name="rating"]').forEach(function(t){t.checked&&(e=t.value)});var t={restaurant_id:self.restaurant.id,name:document.getElementById("fname").value,rating:e,comments:document.getElementById("fcomment").value},n={method:"POST",body:JSON.stringify(t)};!1===navigator.onLine&&(n.mode="no-cors"),fetch(DBHelper.getDbUrl("reviews/"),n).then(function(e){return 201===e.status?e.json():302===e.status?(t.storageLocal=!0,t):void 0}).then(function(e){document.getElementById("reviews-list").appendChild(createReviewHTML(e)),e.storageLocal||send_message_to_sw({action:"saveDataToIdb",store:"reviews",value:e}),document.getElementById("fname").value="",document.getElementsByName("rating")[4].checked=!0,document.getElementById("fcomment").value=""}).catch(function(e){return console.log(e)})},fillBreadcrumb=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:self.restaurant,t=document.getElementById("breadcrumb"),n=document.createElement("li");n.innerHTML=e.name,t.appendChild(n)},getParameterByName=function(e,t){t||(t=window.location.href),e=e.replace(/[\[\]]/g,"\\$&");var n=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)").exec(t);return n?n[2]?decodeURIComponent(n[2].replace(/\+/g," ")):"":null},_refreshing=!1,_isVisible=!0,_askUserWhenSwUpdated=!0,_isOffline=!1,_swUrl="",_msgOffline="",_msgWhenUpdate="",_msgWhenSwUpdated="",_msgSync="",_preCache="";function initConfig(e){_swUrl=e.swUrl,_msgOffline=e.msgOffline,_msgWhenUpdate=e.msgWhenUpdate,_msgWhenSwUpdated=e.msgWhenSwUpdated,_preCache=e.preCache,_askUserWhenSwUpdated=e.askUserWhenSwUpdated,_msgSync=e.msgSync}function serviceWorkerRegistration(){if(navigator.serviceWorker)return"onReload"===_preCache&&navigator.serviceWorker.addEventListener("controllerchange",function(){_refreshing||(window.location.reload(),_refreshing=!0)}),navigator.serviceWorker.register(_swUrl,{scope:"/"}).then(function(e){console.log("Service Worker Registered"),console.log("MNPWA service worker ready"),"onAnalyzePage"===_preCache&&e.installing&&e.installing.postMessage({action:"set-preCache",urls:getAllCssJsImgFromPage()}),navigator.serviceWorker.controller&&(e.waiting?updateReady(e):e.installing?trackingprogressInstalled(e.installing):e.addEventListener("updatefound",function(){trackingprogressInstalled(e.installing)}))}).catch(function(e){return console.log("Service worker not registered: ",e)})}function updateReady(e){var t=!0;_askUserWhenSwUpdated&&(t=confirm(_msgWhenSwUpdated)),t&&e.postMessage({action:"skipWaiting"})}function trackingprogressInstalled(e){e.addEventListener("statechange",function(){"installed"==e.state&&updateReady(e)})}function setStyleSw(){var e="body.state-offline .offline-indicator, body.state-offline .offline-indicator--top {\n        -webkit-transform: translateY(0);\n        -moz-transform: translateY(0);\n        -ms-transform: translateY(0);\n        -o-transform: translateY(0);\n        transform: translateY(0);\n    }\n    .offline-indicator {\n        background-color: rgba(0, 0, 0, 0.8);\n        color: #fff;\n        padding: .9rem;\n        position: fixed;\n        z-index: 9999999999999999;\n        left: 0;\n        bottom: 0;\n        width: 100%;\n        -webkit-transform: translateY(100%);\n        -moz-transform: translateY(100%);\n        -ms-transform: translateY(100%);\n        -o-transform: translateY(100%);\n        transform: translateY(100%);\n        will-change: transform;\n        -webkit-transition: -webkit-transform 200ms ease-in-out;\n        -webkit-transition-delay: 0s;\n        -moz-transition: -moz-transform 200ms ease-in-out;\n        -o-transition: -o-transform 200ms ease-in-out;\n        transition: transform 200ms ease-in-out false;\n    }\n    .offline-indicator p {\n        margin: 0 40px 0 0;\n        color: #fff;\n        text-align: center;\n    }\n    .offline-indicator .close-indicator {\n        position: absolute;\n        top: 0;\n        right: 0;\n        width: 45px;\n        height: 100%;\n        padding: 0;\n        background: #000;\n        border: none;\n        font-size: 27px;\n        font-weight: normal;\n        border-radius: 0;\n        color: #FFF;\n    }\n    .offline-indicator .close-indicator:hover,\n    .offline-indicator .close-indicator:focus {\n        background: #575757;\n    }\n    .offline-indicator a {\n        color: #FFF;\n        font-weight: bold;\n        text-decoration: underline;\n    }",t=document.head||document.getElementsByTagName("head")[0],n=document.createElement("style");n.type="text/css",n.styleSheet?n.styleSheet.cssText=e:n.appendChild(document.createTextNode(e)),t.appendChild(n)}function setSwMsgContianer(){var e=document.createElement("div");e.className="offline-indicator offline-indicator--bottom";var t=document.createElement("p");t.id="msgOffline",e.appendChild(t);var n=document.createElement("button");n.type="button",n.className="close-indicator",n.setAttribute("aria-label","close-indicator"),n.addEventListener("click",hideMsg);var a=document.createElement("span");a.innerHTML="&times;",n.appendChild(a),e.appendChild(n),document.body.appendChild(e),window.addEventListener("online",updateNetworkState),window.addEventListener("offline",updateNetworkState)}function updateNetworkState(){navigator.onLine?(_isOffline=!1,hideMsg()):(_isOffline=!0,showMsg()),send_message_to_sw({action:"updateNetworkState",value:_isOffline})}function getAllCssJsImgFromPage(){var e=[],t=!0,n=!1,a=void 0;try{for(var r,i=document.styleSheets[Symbol.iterator]();!(t=(r=i.next()).done);t=!0)CSSStyleSheet=r.value,null!==CSSStyleSheet.href&&CSSStyleSheet.href.match(/^(http|https):\/\//i)&&e.push(CSSStyleSheet.href)}catch(e){n=!0,a=e}finally{try{!t&&i.return&&i.return()}finally{if(n)throw a}}var o=!0,s=!1,c=void 0;try{for(var l,u=document.images[Symbol.iterator]();!(o=(l=u.next()).done);o=!0)image=l.value,null!==image.src&&image.src.match(/^(http|https):\/\//i)&&e.push(image.src)}catch(e){s=!0,c=e}finally{try{!o&&u.return&&u.return()}finally{if(s)throw c}}var d=!0,f=!1,m=void 0;try{for(var h,g=document.scripts[Symbol.iterator]();!(d=(h=g.next()).done);d=!0)script=h.value,null!==script.src&&"SCRIPT"===script.tagName&&""!==script.src&&script.src.match(/^(http|https):\/\//i)&&e.push(script.src)}catch(e){f=!0,m=e}finally{try{!d&&g.return&&g.return()}finally{if(f)throw m}}return e}function handleVisibilityChange(){_isVisible=!document.hidden}function send_message_to_sw(e){if(navigator.serviceWorker.controller)return new Promise(function(t,n){var a=new MessageChannel;a.port1.onmessage=function(e){e.data.error?n(e.data.error):t(e.data)},navigator.serviceWorker.controller.postMessage(e,[a.port2])})}function sendMsgChecksToSw(){window.addEventListener("load",function(){updateNetworkState()})}function listenToMessages(){navigator.serviceWorker.addEventListener("message",function(e){"reloadThePageForMAJ"===e.data&&showMsg(_msgWhenUpdate),"isVisible"===e.data&&e.ports[0].postMessage(_isVisible),"isOffline"===e.data&&e.ports[0].postMessage(_isOffline),"NotifyUserReqSaved"===e.data&&showMsg(" - "+_msgSync)})}function showMsg(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t="";_isOffline&&(t+=_msgOffline),""!==e&&(t+=e),document.getElementById("msgOffline").innerHTML=t,document.body.classList.add("state-offline")}function hideMsg(){document.body.classList.remove("state-offline")}document.addEventListener("visibilitychange",handleVisibilityChange,!1),function(){if("serviceWorker"in navigator){initConfig({swUrl:"sw/service-worker.js",msgOffline:"You're currently offline",msgWhenUpdate:'The contents of this page have been updated. Please <a href="javascript:location.reload()">reload</a>',askUserWhenSwUpdated:!1,msgSync:"Your submit is saved and will auto-submit when you're online",msgWhenSwUpdated:"New version available online. Do you want to update? ",preCache:"onReload"}),serviceWorkerRegistration().then(function(){listenToMessages(),setStyleSw(),setSwMsgContianer(),sendMsgChecksToSw()})}}();