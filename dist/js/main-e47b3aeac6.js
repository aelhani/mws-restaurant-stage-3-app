"use strict";var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var fetchRestaurantsData=null,DBHelper=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"fetchRestaurants",value:function(){return fetchRestaurantsData||fetch(e.DATABASE_URL).then(function(e){return e.json()}).then(function(e){return fetchRestaurantsData=Promise.resolve(e),e}).catch(function(e){console.log(e)})}},{key:"fetchRestaurantById",value:function(t){return e.fetchRestaurants().then(function(e){return e.find(function(e){return e.id==t})})}},{key:"fetchRestaurantByCuisine",value:function(t){return e.fetchRestaurants().then(function(e){return e.filter(function(e){return e.cuisine_type==t})})}},{key:"fetchRestaurantByNeighborhood",value:function(t){return e.fetchRestaurants().then(function(e){return e.filter(function(e){return e.neighborhood==t})})}},{key:"fetchRestaurantByCuisineAndNeighborhood",value:function(t,n){return e.fetchRestaurants().then(function(e){var r=e;return"all"!=t&&(r=r.filter(function(e){return e.cuisine_type==t})),"all"!=n&&(r=r.filter(function(e){return e.neighborhood==n})),r})}},{key:"fetchNeighborhoods",value:function(){return e.fetchRestaurants().then(function(e){var t=e.map(function(t,n){return e[n].neighborhood});return t.filter(function(e,n){return t.indexOf(e)==n})})}},{key:"fetchCuisines",value:function(){return e.fetchRestaurants().then(function(e){var t=e.map(function(t,n){return e[n].cuisine_type});return t.filter(function(e,n){return t.indexOf(e)==n})})}},{key:"urlForRestaurant",value:function(e){return"./restaurant.html?id="+e.id}},{key:"imageUrlForRestaurant",value:function(e){return"/img/"+e.photograph}},{key:"srcsetImageUrlForRestaurant",value:function(e){return e.srcset_restaurant}},{key:"srcsetImageUrlForIndex",value:function(e){return e.srcset_index}},{key:"mapMarkerForRestaurant",value:function(t,n){var r=new L.marker([t.latlng.lat,t.latlng.lng],{title:t.name,alt:"Localisation of "+t.name+" restaurant",url:e.urlForRestaurant(t)});return r.addTo(newMap),r}},{key:"DATABASE_URL",get:function(){return"http://localhost:1337/restaurants"}}]),e}(),restaurants=void 0,neighborhoods=void 0,cuisines=void 0,newMap=void 0,markers=[],fetchNeighborhoods=function(){DBHelper.fetchNeighborhoods().then(function(e){self.neighborhoods=e,fillNeighborhoodsHTML()}).catch(function(e){console.error(e)})},fillNeighborhoodsHTML=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:self.neighborhoods,t=document.getElementById("neighborhoods-select");e.forEach(function(e){var n=document.createElement("option");n.innerHTML=e,n.value=e,t.append(n)})},fetchCuisines=function(){DBHelper.fetchCuisines().then(function(e){self.cuisines=e,fillCuisinesHTML()}).catch(function(e){console.error(e)})},fillCuisinesHTML=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:self.cuisines,t=document.getElementById("cuisines-select");e.forEach(function(e){var n=document.createElement("option");n.innerHTML=e,n.value=e,t.append(n)})},initMap=function(){return newMap=L.map("map",{center:[40.722216,-73.987501],zoom:12,scrollWheelZoom:!1}),L.tileLayer("https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.jpg70?access_token={mapboxToken}",{mapboxToken:"pk.eyJ1IjoibW9oY2luZTkyIiwiYSI6ImNqa21lY3JoZjF1cGozcXBrOGI5cnRlNGkifQ.VcGgA3YMmeEWpARnDTyxDQ",maxZoom:18,attribution:'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',id:"mapbox.streets"}).addTo(newMap),updateRestaurants()},updateRestaurants=function(){var e=document.getElementById("cuisines-select"),t=document.getElementById("neighborhoods-select"),n=e.selectedIndex,r=t.selectedIndex,a=e[n].value,o=t[r].value;return DBHelper.fetchRestaurantByCuisineAndNeighborhood(a,o).then(function(e){resetRestaurants(e),fillRestaurantsHTML()}).catch(function(e){console.log(e)})},resetRestaurants=function(e){self.restaurants=[],document.getElementById("restaurants-list").innerHTML="",self.markers&&self.markers.forEach(function(e){return e.remove()}),self.markers=[],self.restaurants=e},fillRestaurantsHTML=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:self.restaurants,t=document.getElementById("restaurants-list");e.forEach(function(e){t.append(createRestaurantHTML(e))}),addMarkersToMap()},createRestaurantHTML=function(e){var t=document.createElement("li"),n=document.createElement("div");n.className="listitem";var r=document.createElement("img");r.setAttribute("alt",e.name),r.className="restaurant-img",r.src=DBHelper.imageUrlForRestaurant(e),r.srcset=DBHelper.srcsetImageUrlForIndex(e),n.append(r);var a=document.createElement("div");a.className="content-wrapper";var o=document.createElement("h3");o.setAttribute("id","res-"+e.id),o.innerHTML=e.name,a.append(o);var i=document.createElement("p");i.innerHTML=e.neighborhood,a.append(i);var s=document.createElement("p");s.innerHTML=e.address,a.append(s);var u=document.createElement("a");return u.innerHTML="View Details",u.setAttribute("aria-labelledby","res-"+e.id),u.href=DBHelper.urlForRestaurant(e),a.append(u),n.append(a),t.append(n),t},addMarkersToMap=function(){(arguments.length>0&&void 0!==arguments[0]?arguments[0]:self.restaurants).forEach(function(e){var t=DBHelper.mapMarkerForRestaurant(e,self.newMap);t.on("click",function(){window.location.href=t.options.url}),self.markers.push(t)})};document.addEventListener("DOMContentLoaded",function(){initMap().then(function(){return fetchNeighborhoods()}).then(function(){return fetchCuisines()})});var refreshing=!1;function serviceWorkerRegistration(){navigator.serviceWorker&&(navigator.serviceWorker.addEventListener("controllerchange",function(){refreshing||(window.location.reload(),refreshing=!0)}),navigator.serviceWorker.register("./service-worker.js").then(function(e){console.log("Service Worker Registered"),navigator.serviceWorker.controller&&(e.waiting?updateReady():e.installing?trackingprogressInstalled(e.installing):e.addEventListener("updatefound",function(){trackingprogressInstalled(e.installing)}))}).catch(function(e){return console.log("Service worker not registered: ",e)}))}function updateReady(e){confirm("New version available online. Do you want to update? ")&&e.postMessage({action:"skipWaiting"})}function trackingprogressInstalled(e){e.addEventListener("statechange",function(){"installed"==e.state&&updateReady(e)})}serviceWorkerRegistration();